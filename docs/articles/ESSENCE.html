<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Going from line list data to an interactive app • ExcessILI</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Going from line list data to an interactive app">
<meta property="og:description" content="ExcessILI">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ExcessILI</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ESSENCE.html">Going from line list data to an interactive app</a>
    </li>
    <li>
      <a href="../articles/ILINet.html">Using ExcessILI with ILINet</a>
    </li>
    <li>
      <a href="../articles/PImortality.html">Using ExcessILI with US P&amp;I mortality data</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Going from line list data to an interactive app</h1>
                        <h4 class="author">Dan Weinberger</h4>
            
            <h4 class="date">3/25/2020</h4>
      
      
      <div class="hidden name"><code>ESSENCE.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p>The goal for this package is to facilitate the formatting of line list data from syndromic surveillance datasets (such as those stored in <a href="https://www.cdc.gov/nssp/index.html">ESSENCE</a> into daily or weekly time series, and then analyzing these data to detect increases above the seasonal baseline. For US data, there is an option to automatically adjust the data for state-specific flu activity (using data from <a href="https://www.cdc.gov/surveillance/nrevss/index.html">NREVSS</a> and/or state-specific RSV activity (based on Google search volume).</p>
<p>In this example, we will demonstrate how to prepare the data obtained from ESSENCE to be used with this package and then how to run the analyses. Thanks to Sara Chronister from Maricopa County, AZ for contributing to this workflow.</p>
</div>
<div id="getting-started" class="section level2">
<h2 class="hasAnchor">
<a href="#getting-started" class="anchor"></a>Getting started</h2>
<p>This package is not available on CRAN, so it needs to be installed directly from Github. Make sure you have the ‘devtools’ package installed.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"># Install development version from GitHub
library(devtools)
devtools::install_github("weinbergerlab/ExcessILI")</pre></body></html></div>
<div class="sourceCode" id="cb2"><html><body><pre class="r">library(ExcessILI)
library(cdcfluview)
#&gt; Warning: package 'cdcfluview' was built under R version 3.6.3</pre></body></html></div>
<p><strong>We recommend installing the cdcfluview package to take full advantage of the ExcessILI package. If you are using the Enterpise version of RStudio on the BioSense platform, cdcfluview might not install correctly.</strong></p>
<p><code>cdcfluview</code>’s dependencies require the packages <code>gdal</code> and <code>udunits</code>, which cannot be installed using R’s package manager. If <code>cdcfluview</code> installation fails for this reason, you’ll need to install these by hand. For installation of these two packages on OS X, we recommend using a package manager such as <a href="https://brew.sh">brew</a>.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r">brew install gdal udunits</pre></body></html></div>
</div>
<div id="prepare-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#prepare-the-data" class="anchor"></a>Prepare the data</h2>
<p>We ultimately want to have a dataset that looks like this, where we have a line for each case, a column for the state (2 digit state), a column for smaller geographic levels if any (e.g., counties, hospitals), a column for the age group, the day of admissions (in a YYY-MM-DD date format), and flags for whether the admission was related to a syndrome of interest, such as “ILI” or “respiratory”. You should have a row in your data for every admission, <em>regardless of the cause.</em></p>
<div class="sourceCode" id="cb4"><html><body><pre class="r">head(ds1)
#&gt;   state      adate    agegrp ili resp   borough
#&gt; 1    NY 2020-05-12   v. 65+y   0    0 Manhattan
#&gt; 2    NY 2020-03-04   v. 65+y   1    0 Manhattan
#&gt; 3    NY 2019-12-25   v. 65+y   0    0 Manhattan
#&gt; 4    NY 2019-01-28 ii. 5-17y   0    0 Manhattan
#&gt; 5    NY 2019-06-02   v. 65+y   0    0 Manhattan
#&gt; 6    NY 2019-11-25 ii. 5-17y   0    0 Manhattan</pre></body></html></div>
</div>
<div id="format-line-list-into-a-time-series" class="section level2">
<h2 class="hasAnchor">
<a href="#format-line-list-into-a-time-series" class="anchor"></a>Format line list into a time series</h2>
<p>We can aggregate by day or week using the function <code><a href="../reference/ts_format.html">ts_format()</a></code></p>
<div class="sourceCode" id="cb5"><html><body><pre class="r">ts1</pre></body></html></div>
<div class="sourceCode" id="cb6"><html><body><pre class="r">head(ts1[,c('agegrp','adate','state','borough', 'ili', 'resp', 'all.visits')])
#&gt;   agegrp      adate state   borough ili resp all.visits
#&gt; 1 i. u5y 2019-01-01    NY     Bronx   0    4         41
#&gt; 2 i. u5y 2019-01-01    NY Manhattan   0    2         17
#&gt; 3 i. u5y 2019-01-02    NY     Bronx   3    2         55
#&gt; 4 i. u5y 2019-01-02    NY Manhattan   2    1         20
#&gt; 5 i. u5y 2019-01-03    NY     Bronx   0    2         48
#&gt; 6 i. u5y 2019-01-03    NY Manhattan   2    1         17</pre></body></html></div>
<p>As an example of how to prepare line list data to be used in the ts_format function, starting from ESSENCE data, here is code from Sara Chronister:</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r">ds1 %
         # extract date only from C_Visit_Date_Time
  mutate(Visit_Date = as.Date(C_Visit_Date_Time),
         # fill in missing HasBeenI with 0
         ifelse(is.na(HasBeenI),0,HasBeenI),
         # concatenate all _flat variables into one classification variable
         classification = paste(Category_flat,SubCategory_flat,CCDDCategory_flat,sep=";"),
         # flag for COVID-like illness
         COVIDlike = ifelse(str_detect(CCDDCategory_flat,"Fever and Cough-Sob-DiffBr neg Influenza DD v1"),1,0),
         # flag for influenza-like illness
         ili = ifelse(str_detect(CCDDCategory_flat,"ILI CCDD v1"),1,0),
         # flag for cough
         cough = ifelse(str_detect(SubCategory_flat,"Cough"),1,0),
         # flag for respiratory
         resp = ifelse(str_detect(Category_flat,"Resp"),1,0),
         # age groups
         Age = as.numeric(Age),
         agegrp = case_when(Age&gt;=0 &amp; Age&lt;20~"00-19Y",
                            Age&gt;=20 &amp; Age&lt;45~"20-44Y",
                            Age&gt;=45 &amp; Age&lt;65~"45-64Y",
                            Age&gt;=65 &amp; Age&lt;150~"65+Y"),
         agegrp = ifelse(is.na(agegrp),"UNK",agegrp),
         # state variable (for use when multiple counties are pulled in)
         state = 'AZ',
         county = str_remove(HospitalRegion,"AZ_"),
         ALL = "ALL") %&gt;%
  filter(agegrp!="UNK")</pre></body></html></div>
</div>
<div id="run-the-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#run-the-analysis" class="anchor"></a>Run the analysis</h2>
<p>Now that we have the formatted time series, we are ready to run the analysis. You can either just fit a seasonal baseline with harmonic waves (default), or you can adjust for influenza activity. If you were able to install the cdcfluview package and have data from the US, you can automatically adjust for influenza activity using data on influenza positive tests from NREVSS. If not, you can merge in your own influenza data with the time series formatted in the steps above, and specify the name of the flu variable.</p>
<p>We need to specify the names of the relevant variables in the dataset ds1. We will fit the regression through the end of Feb 2020 and then extrapolate forward based on the seasonal baseline and observed flu activity. We adjust for flu using the ‘auto’ option, which will download the latest NREVSS testing data</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r">excess_cases1  Warning in data(cdcfluview::hhs_regions): data set
#&gt; 'cdcfluview::hhs_regions' not found</pre></body></html></div>
</div>
<div id="generate-an-interactive-dashboard" class="section level2">
<h2 class="hasAnchor">
<a href="#generate-an-interactive-dashboard" class="anchor"></a>Generate an interactive dashboard</h2>
<p>You can take the results of the excessCases function and generate an interactive dashboard by running the following line. This is especially useful if you have a lot of regions, age groups, and syndromes to explore. You can also view the time series of raw cases, the proportion, or the observed/expected.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="../reference/dashboardPlot.html">dashboardPlot</a></span>(<span class="no">excess_cases1</span>)</pre></body></html></div>
<iframe src="https://weinbergerlab.shinyapps.io/NYC_syndromic/" width="100%" height="600px" class="shiny-app">
</iframe>
</div>
<div id="generate-static-versions-of-the-plots" class="section level2">
<h2 class="hasAnchor">
<a href="#generate-static-versions-of-the-plots" class="anchor"></a>Generate static versions of the plots</h2>
<div id="extract-the-quantities-of-interest" class="section level3">
<h3 class="hasAnchor">
<a href="#extract-the-quantities-of-interest" class="anchor"></a>Extract the quantities of interest</h3>
<p>Which syndrome do you want to plot, and over what time range?</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">syndrome.select</span> <span class="kw">&lt;-</span> <span class="st">'ili'</span> <span class="co">#which syndrome do you want to plot?</span>
<span class="no">n.days</span> <span class="kw">&lt;-</span> <span class="fl">365</span>  <span class="co">#How many days to plot?</span></pre></body></html></div>
<p>Extract the data needed to plot from the results</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r">library(magrittr)
library(purrr)
#&gt; 
#&gt; Attaching package: 'purrr'
#&gt; The following object is masked from 'package:magrittr':
#&gt; 
#&gt;     set_names

dates %
           setNames(resultsNames)</pre></body></html></div>
<p>Generate the plots</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r">
select.indices </pre></body></html></div>
<p><img src="ESSENCE_files/figure-html/unnamed-chunk-14-1.png" width="960"><img src="ESSENCE_files/figure-html/unnamed-chunk-14-2.png" width="960"><img src="ESSENCE_files/figure-html/unnamed-chunk-14-3.png" width="960"><img src="ESSENCE_files/figure-html/unnamed-chunk-14-4.png" width="960"><img src="ESSENCE_files/figure-html/unnamed-chunk-14-5.png" width="960"><img src="ESSENCE_files/figure-html/unnamed-chunk-14-6.png" width="960"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Daniel Weinberger, Marcus Russi.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.0.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
